---
title: 亮点和不足
date: 2015-11-21 02:33:45
tags: 反思
categories: 技术
---

### 1、一键加油的数据缓存操作

* 添加缓存

		原因：
			开发过程，由于测试服务器的网络带宽，客户端请求数据超级慢，用户的体验非常不好。
		工具：
			sharedPreference：
		流程：
			1、将一键加油的数据，在进入到主页的时候，进行请求完成，将JSON,时间，当前请求的位置等数据缓存到本地
			2、在进入到一键加油的流程时候，先拿到本地缓存的数据，对时间和位置进行对比，时间超过5分钟，位置移动超过20m，都会重新向服务器请求数据。
			3、在首页生命周期走到onStop()方法时候，将缓存数据进行致空（json="";）操作。
			4、3的操作，保证每次打开首页进入到一键加油流程都是最新的数据，同样也保证再次回到首页的时候，在网络情况差，请求不到数据的情况，不会使用上一次缓存的数据
		优点：
			优化用户体验，节省流量
		缺点：暂未发现

<!--more-->

### 2、热修复功能的是实现

* 添加的热修复框架

		来源：
			使用的是阿里开源的一个Android热补丁框架（AndFix）
		功能：
			允许APP在不重新发布版本的情况下修复线上的bug。
		原理：
			apkpatch将两个apk做一次对比，然后找出不同的部分。可以看到生成的apatch了文件，后缀改成zip再解压开，里面有一个dex文件。通过jadx查看一下源码，
			里面就是被修复的代码所在的类文件,这些更改过的类都加上了一个_CF的后缀，并且变动的方法都被加上了一个叫@MethodReplace的annotation，
			通过clazz和method指定了需要替换的方法。然后客户端sdk得到补丁文件后就会根据annotation来寻找需要替换的方法。最后由JNI层完成方法的替换。
		优点：
			1、不需要重启APP即可应用补丁。
            Do not need to restart the APP can apply the patch
			2、安全性更好，Nuwa后面的版本应该也会加上安全方面的内容。
            Better security, Nuwa version should also be followed by the security aspects of the content

		支持：
			Android 2.3 到 6.0。
		格式：
			.apatch
		安全：
			必须使用签名工具进行操作生成的apatch文件，才能进行patch操作
		局限：
			1、不支持YunOS
			2、无法添加新类和新的字段
			3、需要使用加固前的apk制作补丁，但是补丁文件很容易被反编译，也就是修改过的类源码容易泄露。
			4、使用加固平台可能会使热补丁功能失效（看到有人在360加固提了这个问题，自己还未验证）。
		缺点：
			无法添加类和字段
		使用：
			打补丁的过程，首先生成一个apk文件，然后更改代码，在修复bug后生成另一个apk。
			通过官方提供的工具apkpatch
			生成一个.apatch格式的补丁文件，需要提供原apk，修复后的apk，以及一个签名文件。
			可以直接使用命令apkpatch查看具体的使用方法。

